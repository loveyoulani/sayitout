<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SayitOUT - Express Yourself</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
        <style>
            :root {
    --primary-gradient: linear-gradient(135deg, #1DA1F2, #4DDFC6);
    --secondary-gradient: linear-gradient(135deg, #1DA1F2, #4DDFC6);
}

body {
    background-color: #15202B;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    line-height: 1.5;
    overflow-y: auto;
    color: #FFFFFF;
}

/* Enhanced Scrollbar Styles */
* {
    scrollbar-width: thin;
    scrollbar-color: #4DDFC6 #192734;
}

*::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

*::-webkit-scrollbar-track {
    background: #192734;
    border-radius: 10px;
}

*::-webkit-scrollbar-thumb {
    background: #4DDFC6;
    border-radius: 10px;
    border: 2px solid #192734;
}

*::-webkit-scrollbar-thumb:hover {
    background: #3dbdb5;
}

.glass-nav {
    background: rgba(25, 39, 52, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.content-card {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 200px;
    max-height: 280px;
    overflow-y: auto;
    background: #192734;
    border: 1px solid #253341;
    border-radius: 1rem;
    transition: all 0.3s ease;
}

.content-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    border-color: #1DA1F2;
}

.content-preview {
    position: relative;
    max-height: 100px;
    overflow-y: auto;
    margin-bottom: 1rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    padding-right: 8px;
}

.content-preview::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 8px;
    height: 40px;
    background: linear-gradient(to bottom, transparent, #192734);
    pointer-events: none;
}

.title-clamp {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    -webkit-line-clamp: 1;
    line-height: 1.3;
    color: #FFFFFF;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.text-clamp {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    -webkit-line-clamp: 3;
    line-height: 1.5;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.content-card h2 {
    font-size: 18px;
    color: #FFFFFF;
    margin-bottom: 0.5rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.gradient-text {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

.gradient-bg {
    background: var(--primary-gradient);
}

.secondary-gradient-bg {
    background: var(--secondary-gradient);
}

.floating-input {
    position: relative;
    margin-bottom: 1.5rem;
}

.floating-input input,
.floating-input textarea {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #253341;
    border-radius: 10px;
    outline: none;
    transition: all 0.3s ease;
    word-wrap: break-word;
    overflow-wrap: break-word;
    background: #192734;
    color: #FFFFFF;
}

.floating-input label {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: #192734;
    padding: 0 0.5rem;
    color: #8899A6;
    transition: all 0.3s ease;
    pointer-events: none;
}

.floating-input input:focus + label,
.floating-input input:not(:placeholder-shown) + label,
.floating-input textarea:focus + label,
.floating-input textarea:not(:placeholder-shown) + label {
    top: 0;
    font-size: 0.875rem;
    color: #4DDFC6;
}

.floating-input input:focus,
.floating-input textarea:focus {
    border-color: #4DDFC6;
    box-shadow: 0 0 0 3px rgba(77, 223, 198, 0.2);
}

.tag {
    background: rgba(77, 223, 198, 0.1);
    color: #4DDFC6;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.modal-content {
    background: #192734;
    border-radius: 20px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    width: calc(100% - 2rem);
    max-width: 42rem;
    margin: 1rem;
    position: relative;
    overflow-wrap: break-word;
    word-wrap: break-word;
    max-height: 90vh;
    overflow-y: auto;
}

#contentForm .modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

.notification {
    position: fixed;
    top: 1rem;
    right: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    background: #192734;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    z-index: 100;
    animation: slideIn 0.3s ease;
    color: #FFFFFF;
}

.reaction-btn {
    padding: 0.5rem 1rem;
    border-radius: 10px;
    transition: all 0.2s ease;
    background: rgba(77, 223, 198, 0.1);
    color: #4DDFC6;
}

.reaction-btn:hover {
    background: rgba(77, 223, 198, 0.2);
    transform: scale(1.05);
}

.spoiler {
    background-color: #253341;
    color: transparent;
    padding: 0 4px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
}

.spoiler:hover {
    background-color: #2C3E50;
}

.spoiler.revealed {
    background-color: #253341;
    color: inherit;
}

.prose {
    font-size: 15px;
    line-height: 1.5;
    color: #FFFFFF;
    word-wrap: break-word;
    overflow-wrap: break-word;
    padding-right: 8px;
}

.prose p {
    margin-bottom: 1rem;
}

.thought, .chat {
    max-width: 100%;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
    padding: 1rem;
    margin: 0.5rem 0;
    border-radius: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    overflow-y: auto;
}

.thought {
    background-color: #253341;
    border: 1px solid #2C3E50;
}

.content-container {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 1rem;
    overflow-y: auto;
}

.thought *, .chat * {
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
}

.metadata {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #8899A6;
}

/* Mobile Specific Styles */
@media (max-width: 640px) {
    .content-card h2 {
        font-size: 16px;
        color: #FFFFFF;
    }
    
    .content-card .prose {
        font-size: 14px;
    }
    
    .mobile-menu {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(25, 39, 52, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 1rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-around;
        z-index: 50;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .mobile-menu button {
        flex: 1;
        margin: 0 0.25rem;
        padding: 0.5rem;
        border-radius: 10px;
        font-size: 0.875rem;
    }
    
    #contentForm {
        align-items: flex-end !important;
        padding: 0 !important;
    }
    
    #contentForm .modal-content {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        border-top-left-radius: 20px !important;
        border-top-right-radius: 20px !important;
        max-height: 85vh !important;
        padding-bottom: calc(env(safe-area-inset-bottom) + 1rem) !important;
    }
    
    #contentDetailModal .modal-content {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0;
        padding: 1.25rem;
    }
    
    #contentDetailModal #detailTitle {
        font-size: 20px;
        color: #FFFFFF;
        line-height: 1.3;
        margin-bottom: 1rem;
    }
    
    #contentDetailModal #detailContent {
        font-size: 15px;
        line-height: 1.5;
        padding: 0;
    }
    
    #contentDetailModal #detailMetadata {
        font-size: 14px;
        margin-bottom: 1.25rem;
    }
    
    #contentDetailModal .prose {
        padding: 0;
    }
    
    main {
        padding-bottom: 5rem;
    }
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
    </style>
</head>
<body class="min-h-screen custom-scrollbar">
    <!-- Navigation -->
    <nav class="fixed w-full z-50 glass-nav bg-[#15202B]">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold gradient-text">SayitOUT</h1>
                <div class="hidden md:flex items-center space-x-4">
                    <div id="userSection" class="hidden items-center space-x-4">
                        <span id="userInfo" class="text-[#8899A6]"></span>
                        <button id="adminDashboardBtn" onclick="toggleAdminDashboard()" 
                                class="hidden px-4 py-2 bg-[#192734] text-white rounded-full hover:bg-opacity-80 transition">
                            Dashboard
                        </button>
                    </div>
                    <button onclick="toggleSearch()" class="p-2 hover:bg-gray-100 rounded-full transition">
                        üîç
                    </button>
                    <button id="shareBtn" onclick="toggleNewContent()" 
                            class="hidden px-6 py-2 gradient-bg text-white rounded-full shadow-md hover:opacity-90 transition">
                        Share
                    </button>
                    <button id="authBtn" onclick="toggleAuthModal()" 
                            class="px-6 py-2 secondary-gradient-bg text-white rounded-full shadow-md hover:opacity-90 transition">
                        Login
                    </button>
                    <button id="logoutBtn" onclick="logout()" 
                            class="hidden px-6 py-2 bg-red-500 text-white rounded-full shadow-md hover:opacity-90 transition">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <div class="md:hidden mobile-menu">
        <button onclick="toggleSearch()" class="text-gray-600 hover:text-gray-900">
            üîç Search
        </button>
        <button id="mobileShareBtn" onclick="toggleNewContent()" class="hidden text-gray-600 hover:text-gray-900">
            ‚úèÔ∏è Share
        </button>
        <button id="mobileAuthBtn" onclick="toggleAuthModal()" class="text-gray-600 hover:text-gray-900">
            üë§ Login
        </button>
        <button id="mobileLogoutBtn" onclick="logout()" class="hidden text-gray-600 hover:text-gray-900">
            üö™ Logout
        </button>
    </div>
    <!-- Main Content Area -->
    <main class="container mx-auto px-4 pt-24 bg-[#15202B]">
        <div class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <h2 class="text-2xl font-bold text-white">Discover Thoughts</h2>
            <div class="flex flex-wrap gap-4">
                <select id="sortBy" onchange="displayContent()" 
                        class="p-2 rounded-lg border border-[#192734] bg-[#192734] text-black focus:border-[#1DA1F2] focus:ring-2 focus:ring-[#1DA1F2] transition-all">
                    <option value="newest">Latest</option>
                    <option value="oldest">Oldest</option>
                    <option value="popular">Popular</option>
                </select>
                <select id="filterType" onchange="displayContent()" 
                        class="p-2 rounded-lg border border-[#192734] bg-[#192734] text-black focus:border-[#1DA1F2] focus:ring-2 focus:ring-[#1DA1F2] transition-all">
                    <option value="all">All</option>
                    <option value="thought">Thoughts</option>
                    <option value="poem">Poems</option>
                    <option value="quote">Quotes</option>
                    <option value="story">Stories</option>
                </select>
            </div>
        </div>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3" id="contentList"></div>
    </main>
    <!-- Modals -->
    <!-- Auth Modal -->
    <div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-md p-6 animate__animated animate__fadeInUp bg-[#192734]">
            <div class="flex justify-between items-center mb-6">
                <h2 id="authTitle" class="text-2xl font-bold text-white">Login</h2>
                <button onclick="toggleAuthModal()" class="text-[#8899A6] hover:text-white">‚úï</button>
            </div>
            <form id="authForm" onsubmit="handleAuth(event)" class="space-y-4">
                <div class="floating-input">
                    <input type="text" id="username" placeholder=" " class="w-full bg-[#15202B] text-white border-[#192734]">
                    <label class="text-[#8899A6]">Username</label>
                </div>
                <div class="floating-input">
                    <input type="password" id="password" placeholder=" " class="w-full bg-[#15202B] text-white border-[#192734]">
                    <label class="text-[#8899A6]">Password</label>
                </div>
                <div id="adminFields" class="hidden floating-input">
                    <input type="password" id="adminSecret" placeholder=" " class="w-full bg-[#15202B] text-white border-[#192734]">
                    <label class="text-[#8899A6]">Admin Secret</label>
                </div>
                <div class="flex justify-between items-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="isAdmin" onchange="toggleAdminFields()">
                        <span class="text-sm text-[#8899A6]">Admin Account</span>
                    </label>
                    <button type="button" onclick="toggleAuthMode()" class="text-[#1DA1F2] hover:text-[#1DA1F2]">
                        <span id="authToggleText">Need an account?</span>
                    </button>
                </div>
                <button type="submit" class="w-full py-3 bg-[#1DA1F2] text-white rounded-lg hover:opacity-90 transition">
                    <span id="authButtonText">Login</span>
                </button>
            </form>
        </div>
    </div>
    <div id="contentForm" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl p-6 animate__animated animate__fadeInUp bg-[#192734]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold gradient-text">Share Your Thoughts</h2>
                <button onclick="toggleNewContent()" class="text-[#8899A6] hover:text-white transition-colors">‚úï</button>
            </div>
            <div class="space-y-4">
                <select id="contentType" class="w-full p-3 rounded-lg border border-[#192734] bg-[#15202B] text-black focus:border-[#1DA1F2] focus:ring-2 focus:ring-[#1DA1F2]">
                    <option value="thought">Random Thought</option>
                    <option value="poem">Poem</option>
                    <option value="quote">Quote</option>
                    <option value="story">Short Story</option>
                </select>
                <div class="floating-input" id="titleContainer">
                    <input type="text" id="contentTitle" placeholder=" " class="w-full bg-[#15202B] text-white border-[#192734]">
                    <label class="text-[#8899A6]">Title (required for stories and poems)</label>
                </div>
                <div class="floating-input">
                    <input type="text" id="authorNickname" placeholder=" " class="w-full bg-[#15202B] text-white border-[#192734]">
                    <label class="text-[#8899A6]">Nickname (optional)</label>
                </div>
                <div class="floating-input">
                    <textarea id="contentText" placeholder=" " class="w-full h-64 resize-none bg-[#15202B] text-white border-[#192734]"></textarea>
                    <label class="text-[#8899A6]">Your thoughts... (Markdown supported)</label>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <div class="space-x-2">
                        <button onclick="toggleNewContent()" 
                                class="px-4 py-2 text-[#8899A6] border border-[#192734] rounded-lg hover:bg-[#253341] hover:text-white transition-colors">
                            Cancel
                        </button>
                        <button onclick="saveContent()" 
                                class="px-4 py-2 text-[#8899A6] border border-[#192734] rounded-lg hover:bg-[#253341] hover:text-white transition-colors">
                            Share
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="contentDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-3xl p-6 animate__animated animate__fadeInUp max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="detailTitle" class="text-2xl font-bold gradient-text"></h2>
                <button onclick="toggleContentDetail()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div id="detailMetadata" class="flex flex-wrap items-center gap-3 mb-6 text-sm"></div>
            <div id="detailContent" class="prose max-w-none mb-6"></div>
            <div class="border-t pt-4 space-y-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div id="detailViews" class="text-gray-600"></div>
                    <div id="reactions" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <button onclick="shareContent(event)" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition flex items-center gap-2">
                        üì§ Share
                    </button>
                </div>
                <div class="flex justify-between items-center">
                    <div id="detailDate" class="text-sm text-gray-500"></div>
                    <button id="deleteThoughtBtn" onclick="deleteThought()" 
                            class="hidden px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="searchModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl p-6 animate__animated animate__fadeInDown bg-[#192734]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Search</h2>
                <button onclick="toggleSearch()" class="text-[#8899A6] hover:text-black">‚úï</button>
            </div>
            <div class="relative mb-6">
                <input type="text" id="searchInput" onkeyup="searchContent()" placeholder="Search thoughts..."
                       class="w-full p-4 pl-12 rounded-lg border border-[#192734] bg-[#15202B] text-black focus:border-[#1DA1F2] focus:ring-2 focus:ring-[#1DA1F2]">
                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-black">üîç</span>
            </div>
            <div id="searchResults" class="max-h-96 overflow-y-auto custom-scrollbar divide-y divide-[#15202B]"></div>
        </div>
    </div>
    <div id="adminDashboard" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-4xl p-6 animate__animated animate__fadeInUp bg-[#192734]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Admin Dashboard</h2>
                <button onclick="toggleAdminDashboard()" class="text-[#8899A6] hover:text-white">‚úï</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-[#15202B] rounded-xl">
                    <h3 class="text-lg font-semibold text-white mb-2">Total Thoughts</h3>
                    <p id="totalThoughts" class="text-3xl font-bold text-[#1DA1F2]">-</p>
                </div>
                <div class="p-6 bg-[#15202B] rounded-xl">
                    <h3 class="text-lg font-semibold text-white mb-2">Total Users</h3>
                    <p id="totalUsers" class="text-3xl font-bold text-[#4DDFC6]">-</p>
                </div>
                <div class="p-6 bg-[#15202B] rounded-xl">
                    <h3 class="text-lg font-semibold text-white mb-2">Latest Activity</h3>
                    <p id="latestActivity" class="text-sm text-[#8899A6]">-</p>
                </div>
            </div>
            <div class="space-y-4">
                <h3 class="text-xl font-semibold text-white-800">Recent Thoughts</h3>
                <div id="recentThoughts" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"></div>
            </div>
        </div>
    </div>
    <script>
        const API_URL = 'https://backend-7sk4.onrender.com';
        let currentContent = null;
        let isAdmin = false;
        let currentUser = null;
        let authToken = localStorage.getItem('token');
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const defaultTags = ['love', 'life', 'inspiration', 'happiness', 'motivation', 'poetry', 'thoughts', 'emotions'];

        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth();
            addLoader();
            setupTagInput();
            setupInfiniteScroll();
            displayContent();
            handleMobileModal();
            setupContentTypeListener();
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('spoiler')) {
                    e.stopPropagation(); 
                    e.target.classList.toggle('revealed');
                }
            });
            document.getElementById('filterType').addEventListener('change', () => {
                currentPage = 1;
                hasMore = true;
                displayContent();
            });
            
            document.getElementById('sortBy').addEventListener('change', () => {
                currentPage = 1;
                hasMore = true;
                displayContent();
            });
            

            const urlParams = new URLSearchParams(window.location.search);
            const thoughtId = urlParams.get('thought');
            
            if (thoughtId) {
                try {
                    // Directly toggle the content detail with the ID
                    toggleContentDetail(thoughtId);
                } catch (error) {
                    console.error('Error loading shared thought:', error);
                    showNotification('Unable to load the shared content. Please try again later.', 'error');
                }
            }


            window.addEventListener('unhandledrejection', event => {
                handleFetchError(event.reason, 'An unexpected error occurred');
            });
        });
        function setupContentTypeListener() {
            const contentType = document.getElementById('contentType');
            const titleInput = document.getElementById('contentTitle');
            const titleContainer = titleInput.parentElement;

            contentType.addEventListener('change', () => {
                const type = contentType.value;
                if (type === 'quote') {
                    titleContainer.style.display = 'none';
                    titleInput.removeAttribute('required');
                } else if (type === 'thought') {
                    titleContainer.style.display = 'block';
                    titleInput.removeAttribute('required');
                } else {
                    titleContainer.style.display = 'block';
                    titleInput.setAttribute('required', 'required');
                }
            });
        }
        function setupTagInput() {
            const tagContainer = document.createElement('div');
            tagContainer.className = 'mb-4 space-y-2';
            tagContainer.innerHTML = `
                <label class="text-sm text-[#8899A6]">Tags</label>
                <div class="flex flex-wrap gap-2 mb-2" id="selectedTags"></div>
                <div class="relative">
                    <input type="text" id="tagInput" 
                        class="w-full p-2 border rounded-lg bg-[#15202B] border-[#192734] text-white placeholder-[#8899A6] focus:border-[#1DA1F2] focus:ring-2 focus:ring-[#1DA1F2] focus:ring-opacity-20"
                        placeholder="Add tags (press Enter to add)"
                        style="color: white !important;">
                    <div id="tagSuggestions" class="hidden absolute z-10 w-full bg-white border border-gray-200 rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg"></div>
                </div>
                <div class="flex flex-wrap gap-2 mt-2">
                    ${defaultTags.map(tag => `
                        <button onclick="addTag('${tag}')" 
                                class="px-3 py-1 text-sm bg-[#192734] text-white border border-[#253341] rounded-full hover:bg-[#253341] transition-colors">
                            #${tag}
                        </button>
                    `).join('')}
                </div>
            `;
            const contentForm = document.querySelector('#contentForm .space-y-4');
            contentForm.insertBefore(tagContainer, contentForm.querySelector('.floating-input:last-of-type'));

            const tagInput = document.getElementById('tagInput');
            const tagSuggestions = document.getElementById('tagSuggestions');
            
            // Force the input text color to be white
            tagInput.style.color = 'black';
            
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tag = tagInput.value.trim().toLowerCase();
                    if (tag) addTag(tag);
                }
            });

            tagInput.addEventListener('input', () => {
                const input = tagInput.value.toLowerCase();
                if (input) {
                    const suggestions = defaultTags.filter(tag => 
                        tag.includes(input) && !getSelectedTags().includes(tag)
                    );
                    
                    tagSuggestions.innerHTML = suggestions.map(tag => `
                        <div onclick="addTag('${tag}')" 
                            class="p-2 cursor-pointer text-white bg-[#15202B] hover:bg-[#192734] transition-colors">
                            #${tag}
                        </div>
                    `).join('');
                    
                    tagSuggestions.classList.remove('hidden');
                    tagSuggestions.style.backgroundColor = '#15202B';
                    tagSuggestions.style.borderColor = '#192734';
                    
                    if (suggestions.length === 0) {
                        tagSuggestions.classList.add('hidden');
                    }
                } else {
                    tagSuggestions.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!tagInput.contains(e.target)) {
                    tagSuggestions.classList.add('hidden');
                }
            });
        }

        function addTag(tag) {
            const selectedTags = document.getElementById('selectedTags');
            const tagInput = document.getElementById('tagInput');
            const tags = getSelectedTags();

            if (!tags.includes(tag) && tags.length < 5) {
                selectedTags.innerHTML += `
                    <div class="inline-flex items-center px-3 py-1 bg-[#192734] text-white rounded-full hover:bg-[#253341] transition-colors">
                        #${tag}
                        <button onclick="removeTag(this)" class="ml-2 text-xs hover:text-red-400" aria-label="Remove tag">
                            √ó
                        </button>
                    </div>
                `;
            }
            tagInput.value = '';
            document.getElementById('tagSuggestions').classList.add('hidden');
        }

        function getSelectedTags() {
            const tags = [];
            document.querySelectorAll('#selectedTags div').forEach(tag => {
                // Get the text content but exclude the √ó symbol
                const tagText = tag.textContent.trim().replace('√ó', '');
                tags.push(tagText.slice(1));
            });
            return tags;
        }

        function removeTag(button) {
            button.parentElement.remove();
        }

        
        function checkAuth() {
            if (authToken) {
                const payload = parseJwt(authToken);
                currentUser = payload;
                isAdmin = payload.isAdmin;
                updateUIForAuth();
            }
        }
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(window.atob(base64));
            } catch (e) {
                return null;
            }
        }
        function updateUIForAuth() {
            document.getElementById('userSection').style.display = 'flex';
            document.getElementById('userInfo').textContent = `Welcome, ${currentUser.username}`;
            document.getElementById('authBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('shareBtn').classList.remove('hidden');
            
            if (isAdmin) {
                document.getElementById('adminDashboardBtn').classList.remove('hidden');
            }
        }
        async function handleAuth(event) {
            event.preventDefault();
            const isLogin = document.getElementById('authButtonText').textContent === 'Login';
            const endpoint = isLogin ? '/api/auth/login' : '/api/auth/register';
            
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };

            if (!isLogin && document.getElementById('isAdmin').checked) {
                data.isAdmin = true;
                data.adminSecret = document.getElementById('adminSecret').value;
            }
            try {
                const response = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const { token } = await response.json();
                localStorage.setItem('token', token);
                authToken = token;
                checkAuth();
                toggleAuthModal();
                showNotification(isLogin ? 'Login successful!' : 'Registration successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }
        function logout() {
            localStorage.removeItem('token');
            authToken = null;
            currentUser = null;
            isAdmin = false;
            location.reload();
        }
        async function displayContent(append = false) {
            if (isLoading || (!hasMore && append)) return;
            
            const contentList = document.getElementById('contentList');
            const filterType = document.getElementById('filterType').value;
            const sortBy = document.getElementById('sortBy').value;
            const loader = document.getElementById('loader');            
            try {
                isLoading = true;
                if (loader) loader.style.display = 'block';
                
                if (!append) {
                    currentPage = 1;
                    hasMore = true;
                    contentList.innerHTML = '';
                }               
                let endpoint = `${API_URL}/api/thoughts?page=${currentPage}&limit=9&filterType=${filterType}&sortBy=${sortBy}`;
                const headers = {};
                const response = await fetch(endpoint, { headers });               
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);               
                const data = await response.json();
                hasMore = data.hasMore;
                
                if (data.thoughts.length === 0 && !append) {
                    contentList.innerHTML = createEmptyState();
                    return;
                }
                
                const newContent = data.thoughts.map(content => createContentCard(content)).join('');
                if (append) {
                    contentList.insertAdjacentHTML('beforeend', newContent);
                } else {
                    contentList.innerHTML = newContent;
                }
                
            } catch (error) {
                handleFetchError(error, 'Failed to load content');
                if (!append) {
                    contentList.innerHTML = createErrorState();
                }
            } finally {
                isLoading = false;
                if (loader) loader.style.display = 'none';
            }
        }
        
        async function saveContent() {
            if (!authToken) {
                showNotification('Please login to share content', 'error');
                return;
            }
            const type = document.getElementById('contentType').value;
            const title = document.getElementById('contentTitle').value.trim();
            const text = document.getElementById('contentText').value.trim();
            const author = document.getElementById('authorNickname').value.trim() || currentUser.username;
            const tags = getSelectedTags();

            try {
                validateContent(text);
                if ((type === 'story' || type === 'poem') && !title) {
                    throw new Error('Title is required for stories and poems');
                }
                if (!text) {
                    throw new Error('Content text is required');
                }
                if (text.length < 10) {
                    throw new Error('Content must be at least 10 characters long');
                }
                if (tags.length === 0) {
                    throw new Error('Please add at least one tag');
                }
                const content = {
                    title: title || 'Untitled',
                    text: formatText(text),
                    type,
                    author,
                    tags,
                    date: new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    timestamp: Date.now()
                };
                const response = await fetch(`${API_URL}/api/thoughts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(content)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save content');
                }
                const savedContent = await response.json();
                document.getElementById('contentTitle').value = '';
                document.getElementById('contentText').value = '';
                document.getElementById('authorNickname').value = '';
                document.getElementById('selectedTags').innerHTML = '';
                toggleNewContent();
                await displayContent();
                showNotification('Your thought has been shared successfully!', 'success');
                
                // Use the saved content's ID directly
                setTimeout(() => toggleContentDetail(savedContent._id), 500);
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function createEmptyState() {
            const isLoggedIn = !!authToken;
            return `
                <div class="col-span-full flex flex-col items-center justify-center p-8 text-[#8899A6]">
                    <div class="text-6xl mb-4">üí≠</div>
                    <h3 class="text-xl font-bold mb-2 text-white">No posts yet</h3>
                    ${isLoggedIn ? 
                        '<p>Be the first to share something!</p>' : 
                        '<p>Login or register to start sharing your thoughts!</p>'
                    }
                    ${!isLoggedIn ? 
                        '<button onclick="toggleAuthModal()" class="mt-4 px-6 py-2 bg-[#1DA1F2] text-white rounded-lg hover:opacity-90 transition">Get Started</button>' : 
                        ''
                    }
                </div>
            `;
        }
        async function deleteThought(thoughtId) {
            if (!isAdmin) return;
            
            const idToDelete = thoughtId || (currentContent && currentContent._id);
            if (!idToDelete) return;

            try {
                const response = await fetch(`${API_URL}/api/thoughts/${idToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                if (!response.ok) throw new Error('Failed to delete content');

                if (thoughtId) {
                    loadAdminDashboard();
                } else {

                    toggleContentDetail();
                }
                
                displayContent();
                showNotification('Content deleted successfully', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }
        async function addReaction(emoji) {
            if (!authToken) {
                showNotification('Please login to react to posts', 'error');
                return;
            }
            
            if (!currentContent || !currentContent._id) return;
            
            try {
                const response = await fetch(`${API_URL}/api/thoughts/${currentContent._id}/react`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ emoji })
                });
                
                if (!response.ok) throw new Error('Failed to update reaction');
                
                const updatedContent = await response.json();
                currentContent = updatedContent;
                setupReactions(updatedContent);
                
                const btn = document.querySelector(`button[data-emoji="${emoji}"]`);
                if (btn) {
                    btn.classList.add('animate__animated', 'animate__bounce');
                    setTimeout(() => btn.classList.remove('animate__animated', 'animate__bounce'), 1000);
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }
        async function loadAdminDashboard() {
        if (!isAdmin) return;
        try {
            const response = await fetch(`${API_URL}/api/admin/dashboard`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            if (!response.ok) throw new Error('Failed to load dashboard data');
            const data = await response.json();
            
            document.getElementById('totalThoughts').textContent = data.totalThoughts;
            document.getElementById('totalUsers').textContent = data.totalUsers;
            document.getElementById('latestActivity').textContent = 
                `Latest thought posted ${new Date(data.recentThoughts[0]?.timestamp).toLocaleString()}`;
            
            // Show all thoughts instead of just recent ones
            const thoughtsResponse = await fetch(`${API_URL}/api/thoughts?limit=${data.totalThoughts}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            if (!thoughtsResponse.ok) throw new Error('Failed to load thoughts');
            const thoughtsData = await thoughtsResponse.json();
            
            document.getElementById('recentThoughts').innerHTML = thoughtsData.thoughts
                .map(thought => `
                    <div class="p-3 bg-white-50 rounded-lg flex justify-between items-center">
                        <div>
                            <h4 class="font-bold">${escapeHtml(thought.title)}</h4>
                            <p class="text-sm text-white-600">by ${escapeHtml(thought.author)}</p>
                        </div>
                        <button onclick="deleteThought('${thought._id}')"
                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition">
                            Delete
                        </button>
                    </div>
                `)
                .join('');

        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
        function toggleAuthModal() {
            const modal = document.getElementById('authModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('username').focus();
            }
        }
        function toggleAuthMode() {
            const isLogin = document.getElementById('authButtonText').textContent === 'Login';
            document.getElementById('authTitle').textContent = isLogin ? 'Register' : 'Login';
            document.getElementById('authButtonText').textContent = isLogin ? 'Register' : 'Login';
            document.getElementById('authToggleText').textContent = isLogin ? 'Already have an account?' : 'Need an account?';
            document.getElementById('adminFields').classList.add('hidden');
            document.getElementById('isAdmin').checked = false;
        }
        function toggleAdminFields() {
            const adminFields = document.getElementById('adminFields');
            const isAdmin = document.getElementById('isAdmin').checked;
            adminFields.classList.toggle('hidden', !isAdmin);
        }
        function toggleNewContent() {
            const contentForm = document.getElementById('contentForm');
            const isHidden = contentForm.classList.contains('hidden');
            
            if (isHidden) {
                document.body.style.overflow = 'hidden';
                contentForm.classList.remove('hidden');
                document.getElementById('contentTitle').focus();
            } else {
                document.body.style.overflow = '';
                contentForm.classList.add('hidden');
                document.getElementById('contentTitle').value = '';
                document.getElementById('contentText').value = '';
                document.getElementById('authorNickname').value = '';
                
            }
        }
        async function toggleContentDetail(contentString) {
            const modal = document.getElementById('contentDetailModal');
            
            if (contentString) {
                try {
                    let content;
                    
                    // Check if it's a MongoDB ID (24 hex chars)
                    if (typeof contentString === 'string' && /^[0-9a-fA-F]{24}$/.test(contentString)) {
                        const response = await fetch(`${API_URL}/api/thoughts/${contentString}`);
                        if (!response.ok) throw new Error('Failed to fetch thought');
                        content = await response.json();
                    } else {
                        try {
                            // Try Base64 decoding
                            const decodedString = decodeURIComponent(escape(atob(contentString)));
                            content = JSON.parse(decodedString);
                        } catch (e) {
                            // If that fails, try direct JSON parsing
                            content = JSON.parse(decodeURIComponent(contentString));
                        }
                    }
                    
                    if (!content || !content.text) {
                        throw new Error('Invalid content format');
                    }

                    currentContent = content;
                    currentContent.title = currentContent.title || 'Untitled';
                    
                    updateDetailView();
                    
                    if (currentContent._id && authToken && modal.classList.contains('hidden')) {
                        incrementViews(currentContent._id);
                    }
                    
                    if (currentContent._id) {
                        const newUrl = `${window.location.pathname}?thought=${currentContent._id}`;
                        window.history.pushState({}, '', newUrl);
                    }
                    
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    
                } catch (error) {
                    console.error('Error parsing content:', error);
                    showNotification('Unable to load the content. Please try again.', 'error');
                }
            } else {
                window.history.pushState({}, '', window.location.pathname);
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        function toggleAdminDashboard() {
            const dashboard = document.getElementById('adminDashboard');
            dashboard.classList.toggle('hidden');
            if (!dashboard.classList.contains('hidden')) {
                loadAdminDashboard();
            }
        }
        function toggleSearch() {
            const modal = document.getElementById('searchModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('searchInput').focus();
            }
        }
        function searchContent() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');

            if (!searchTerm) {
                resultsContainer.innerHTML = '';
                return;
            }

            fetch(`${API_URL}/api/thoughts`)
                .then(response => response.json())
                .then(data => {
                    // Extract thoughts array from paginated response
                    const thoughts = data.thoughts || [];
                    
                    const filtered = thoughts.filter(content =>
                        content.title.toLowerCase().includes(searchTerm) ||
                        content.text.toLowerCase().includes(searchTerm)
                    );

                    resultsContainer.innerHTML = filtered.length ?
                        filtered.map(content => `
                            <div class="p-4 border-b cursor-pointer hover:bg-gray-50 transition"
                                onclick="toggleSearch(); toggleContentDetail('${encodeURIComponent(JSON.stringify(content))}')">
                                <h3 class="font-bold">${escapeHtml(content.title)}</h3>
                                <p class="text-sm text-gray-600">${escapeHtml(content.text.substring(0, 100))}...</p>
                            </div>
                        `).join('') :
                        '<div class="p-4 text-gray-500">No results found</div>';
                })
                .catch(error => handleFetchError(error, 'Search failed'));
        }
        
        function updateDetailView() {
            if (!currentContent) return;
            try {
                const detailTitle = document.getElementById('detailTitle');
                const detailMetadata = document.getElementById('detailMetadata');
                const detailContent = document.getElementById('detailContent');
                const detailViews = document.getElementById('detailViews');
                const deleteThoughtBtn = document.getElementById('deleteThoughtBtn');
                const detailTags = document.getElementById('detailTags');

                // Format date properly
                const formatDate = (dateString) => {
                    try {
                        if (!dateString) return new Date().toLocaleString();
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return new Date().toLocaleString();
                        return date.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                    } catch (err) {
                        return new Date().toLocaleString();
                    }
                };

                // Title
                if (detailTitle) {
                    detailTitle.className = 'text-2xl font-bold mb-0.5 md:mb-4 text-white';
                    detailTitle.textContent = currentContent.title || 'Untitled';
                }

                // Metadata
                if (detailMetadata) {
                    detailMetadata.className = 'flex flex-wrap items-center gap-1.5 md:gap-3 mb-1.5 md:mb-6';
                    detailMetadata.innerHTML = `
                        <span class="px-2 py-0.5 rounded-full bg-[#192734] text-[#4DDFC6] border border-[#253341]">
                            ${escapeHtml(currentContent.type || 'thought')}
                        </span>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1">
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path>
                                </svg>
                                <span class="text-gray-400 text-sm">
                                    ${escapeHtml(currentContent.author || 'Anonymous')}
                                </span>
                            </div>
                            <div class="flex items-center gap-1">
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                </svg>
                                <span class="text-gray-400 text-sm">
                                    ${formatDate(currentContent.date)}
                                </span>
                            </div>
                        </div>
                    `;
                }

                // Tags
                if (detailTags && currentContent.tags && currentContent.tags.length > 0) {
                    detailTags.className = 'flex flex-wrap gap-1 md:gap-2 mb-1.5 md:mb-4';
                    detailTags.innerHTML = currentContent.tags.map(tag => `
                        <span class="text-[#00b4ff] text-sm font-medium hover:opacity-80 cursor-pointer">
                            #${escapeHtml(tag)}
                        </span>
                    `).join('');
                }

                // Content with preserved line breaks
                if (detailContent) {
                    const sanitizedText = escapeHtml(currentContent.text || '');
                    const processedText = processSpoilerText(sanitizedText);
                    detailContent.className = 'prose max-w-none mb-2 md:mb-6 text-gray-200 whitespace-pre-line';
                    detailContent.innerHTML = marked.parse(processedText);
                    
                    // Spoiler functionality
                    detailContent.querySelectorAll('.spoiler').forEach(spoiler => {
                        spoiler.addEventListener('click', (e) => {
                            e.stopPropagation();
                            spoiler.classList.toggle('revealed');
                        });
                    });
                }

                // Views
                if (detailViews) {
                    detailViews.className = 'flex items-center gap-0.5 text-gray-400';
                    detailViews.innerHTML = `üëÅÔ∏è‚Äçüó®Ô∏è ${currentContent.views || 0} views`;
                }

                // Delete button for admins
                if (deleteThoughtBtn) {
                    deleteThoughtBtn.className = `${isAdmin ? 'flex' : 'hidden'} items-center px-3 py-1.5 text-sm font-medium text-red-500 hover:text-red-400`;
                    deleteThoughtBtn.innerHTML = `
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete
                    `;
                }

                // Setup reactions
                setupReactions(currentContent);

            } catch (error) {
                console.error('Error updating detail view:', error);
                showNotification('Error displaying content details', 'error');
            }
        }
        function setupReactions(content) {
            const reactions = document.getElementById('reactions');
            const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢'];
            reactions.innerHTML = emojis.map(emoji => {
                const reactionList = content.reactions && content.reactions[emoji] || [];
                const hasReacted = reactionList.some(r => r.userId === currentUser?.id);
                const count = reactionList.length;
                return `
                    <button onclick="addReaction('${emoji}')"
                            class="emoji-reaction px-3 py-1 rounded-lg ${hasReacted ? 'bg-[#253341]' : 'bg-[#192734]'} 
                                hover:bg-[#253341] transition text-white"
                            data-emoji="${emoji}">
                        ${emoji} ${count}
                    </button>
                `;
            }).join('');
        }
        async function incrementViews(thoughtId) {
            if (!thoughtId || !authToken) return; 
            try {
                const response = await fetch(`${API_URL}/api/thoughts/${thoughtId}/view`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}` 
                    }
                });
                if (!response.ok) throw new Error('Failed to update views');
                const updated = await response.json();
                if (currentContent) {
                    currentContent.views = updated.views;
                    const detailViews = document.getElementById('detailViews');
                    if (detailViews) {
                        detailViews.innerHTML = `üëÅÔ∏è‚Äçüó®Ô∏è ${updated.views} views`;
                    }
                    const cardViews = document.querySelector(`[data-thought-id="${thoughtId}"] .view-count`);
                    if (cardViews) {
                        cardViews.textContent = `üëÅÔ∏è‚Äçüó®Ô∏è ${updated.views}`;
                    }
                }
            } catch (error) {
                console.error('Error updating views:', error);
            }
        }
        function createErrorState() {
            return `
                <div class="col-span-full flex flex-col items-center justify-center p-8 text-[#8899A6]">
                    <div class="text-6xl mb-4">üòÖ</div>
                    <h3 class="text-xl font-bold mb-2 text-white">Oops! Something went wrong</h3>
                    <p>Please try again later</p>
                </div>
            `;
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg animate__animated animate__fadeIn z-50 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            } text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.replace('animate__fadeIn', 'animate__fadeOut');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        function handleFetchError(error, defaultMessage) {
            console.error('API Error:', error);
            showNotification(error.message || defaultMessage, 'error');
        }
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function createContentCard(content) {
            try {
                if (!content || typeof content !== 'object') {
                    console.error('Invalid content object:', content);
                    return '';
                }

                // Base64 encode the content to handle special characters safely
                const encodedContent = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
                
                const title = content.title || 'Untitled';
                const text = content.text || '';
                const type = content.type || 'thought';
                const author = content.author || 'Anonymous';
                const date = content.date || new Date().toLocaleString();
                const views = content.views || 0;
                const tags = Array.isArray(content.tags) ? content.tags : [];

                const formattedText = formatText(text);
                // For preview, truncate but preserve newlines
                const truncatedText = truncateText(formattedText, 150);
                
                // Process the text with marked while preserving line breaks
                const processedText = typeof marked === 'function' 
                    ? marked(processSpoilerText(escapeHtml(truncatedText)).replace(/\n/g, '<br>'))
                    : processSpoilerText(escapeHtml(truncatedText)).replace(/\n/g, '<br>');

                return `
                    <article class="content-card p-4 cursor-pointer animate__animated animate__fadeIn"
                            data-thought-id="${content._id}"
                            onclick="toggleContentDetail('${encodedContent}')">
                        <div class="flex flex-col h-full">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-lg font-bold text-white hover:text-teal-600 transition title-clamp">
                                    ${escapeHtml(title)}
                                </h2>
                                <span class="tag text-xs flex-shrink-0 ml-2">
                                    ${escapeHtml(type)}
                                </span>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">
                                By ${escapeHtml(author)}
                            </div>
                            <div class="content-preview flex-grow">
                                <div class="prose prose-sm max-w-none text-clamp text-gray-200">
                                    ${processedText}
                                </div>
                            </div>
                            <div class="mt-auto pt-3 border-t border-gray-700">
                                <div class="flex flex-wrap gap-1 mb-2">
                                    ${tags.map(tag => `
                                        <span class="text-xs font-medium" style="color: #00b4ff">#${escapeHtml(tag)}</span>
                                    `).slice(0, 3).join('')}
                                    ${tags.length > 3 ? `<span class="text-xs" style="color: #00b4ff">+${tags.length - 3}</span>` : ''}
                                </div>
                                <div class="flex justify-between items-center text-xs text-gray-400">
                                    <span class="flex items-center gap-1 view-count">üëÅÔ∏è‚Äçüó®Ô∏è ${views}</span>
                                    <span>${escapeHtml(date)}</span>
                                </div>
                            </div>
                        </div>
                    </article>
                `;
            } catch (error) {
                console.error('Error creating content card:', error);
                return '';
            }
        }

        function updateMobileUI(isAuthenticated) {
                const mobileShareBtn = document.getElementById('mobileShareBtn');
                const mobileAuthBtn = document.getElementById('mobileAuthBtn');
                const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');

                if (isAuthenticated) {
                    mobileShareBtn.classList.remove('hidden');
                    mobileAuthBtn.classList.add('hidden');
                    mobileLogoutBtn.classList.remove('hidden');
                } else {
                    mobileShareBtn.classList.add('hidden');
                    mobileAuthBtn.classList.remove('hidden');
                    mobileLogoutBtn.classList.add('hidden');
                }
            }
            const originalUpdateUIForAuth = updateUIForAuth;
            updateUIForAuth = function() {
                originalUpdateUIForAuth();
                updateMobileUI(true);
            }
            const originalLogout = logout;
            logout = function() {
                originalLogout();
                updateMobileUI(false);
            }

        function handleMobileModal() {
            const contentForm = document.getElementById('contentForm');
            const modalContent = contentForm.querySelector('.modal-content');
            
            function closeModal() {
                document.body.style.overflow = '';
                contentForm.classList.add('hidden');
                resetForm();
            }

            function openModal() {
                document.body.style.overflow = 'hidden';
                contentForm.classList.remove('hidden');
                document.getElementById('contentTitle').focus();
            }

            function resetForm() {
                document.getElementById('contentTitle').value = '';
                document.getElementById('contentText').value = '';
                document.getElementById('authorNickname').value = '';
                
            }
            contentForm.addEventListener('click', (e) => {
                if (e.target === contentForm) {
                    closeModal();
                }
            });
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            document.getElementById('mobileShareBtn').addEventListener('click', openModal);
            document.getElementById('shareBtn').addEventListener('click', openModal);
            const closeButton = modalContent.querySelector('button[onclick="toggleNewContent()"]');
            if (closeButton) {
                closeButton.addEventListener('click', closeModal);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            displayContent();
            handleMobileModal();
            window.addEventListener('unhandledrejection', event => {
                handleFetchError(event.reason, 'An unexpected error occurred');
            });
        }); 
        document.getElementById('sortBy').innerHTML = `
            <option value="newest">Latest</option>
            <option value="oldest">Oldest</option>
            <option value="popular">Popular</option>
        `;
        function truncateText(text, maxLength = 300) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength).trim() + '...';
        }
        function processSpoilerText(text) {
            return text.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');
        }
        

        function formatText(text) {
            // Early validation
            if (!text || typeof text !== 'string') {
                return '';
            }

            // Normalize line endings and trim
            const normalizedText = text.replace(/\r\n/g, '\n').trim();
            const lines = normalizedText.split('\n');

            // Detect if text is likely a poem
            const isPoem = detectPoem(lines);
            
            if (isPoem) {
                // For poems, preserve all line breaks and stanza structure
                return preservePoetryFormat(lines);
            }

            // For prose, apply smart paragraph breaks
            return formatProse(lines);
        }

        function detectPoem(lines) {
            if (lines.length < 2) return false;
            
            const characteristics = {
                shortLines: 0,
                rhymingLines: 0,
                consistentIndentation: 0,
                stanzaBreaks: 0
            };

            let previousLine = '';
            let stanzaBreakCount = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Count short lines (typical in poetry)
                if (line.length > 0 && line.length < 50) {
                    characteristics.shortLines++;
                }

                // Check for rhyming patterns
                if (previousLine && line) {
                    if (mightRhyme(getLastWord(previousLine), getLastWord(line))) {
                        characteristics.rhymingLines++;
                    }
                }

                // Check for consistent indentation patterns
                if (i > 0 && line && lines[i-1] && 
                    line.match(/^\s*/)[0].length === lines[i-1].match(/^\s*/)[0].length) {
                    characteristics.consistentIndentation++;
                }

                // Count stanza breaks (empty lines between groups of text)
                if (!line && previousLine) {
                    stanzaBreakCount++;
                }

                previousLine = line;
            }

            characteristics.stanzaBreaks = stanzaBreakCount;

            // Calculate poetry likelihood score
            const score = (
                (characteristics.shortLines / lines.length) * 0.4 +
                (characteristics.rhymingLines / (lines.length - 1)) * 0.3 +
                (characteristics.consistentIndentation / (lines.length - 1)) * 0.15 +
                (characteristics.stanzaBreaks > 0 ? 0.15 : 0)
            );

            return score > 0.5;
        }

        function preservePoetryFormat(lines) {
            // Preserve all original line breaks and spacing for poems
            return lines.join('\n');
        }

        function formatProse(lines) {
            const formattedLines = [];
            const SENTENCE_ENDINGS = /[.!?]+$/;
            const CONJUNCTION_STARTS = /^(and|but|or|nor|for|yet|so|because|however|therefore|moreover|furthermore|consequently|thus|meanwhile|nevertheless|otherwise|alternatively)/i;
            const QUOTE_STARTS = /^["'""]/;
            const QUOTE_ENDS = /["'""]$/;
            const PARENTHETICAL_CONTENT = /\([^)]*\)/;
            
            let currentParagraph = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line) {
                    // Handle empty lines as intentional paragraph breaks
                    if (currentParagraph.length) {
                        formattedLines.push(currentParagraph.join(' '));
                        currentParagraph = [];
                    }
                    formattedLines.push('');
                    continue;
                }

                const nextLine = lines[i + 1] ? lines[i + 1].trim() : '';
                
                currentParagraph.push(line);

                // Determine if we need a paragraph break
                const needsBreak = (
                    // End of text
                    !nextLine ||
                    // Current line ends with sentence ending and next line doesn't start with conjunction
                    (SENTENCE_ENDINGS.test(line) && !CONJUNCTION_STARTS.test(nextLine)) ||
                    // Quote boundaries
                    (QUOTE_ENDS.test(line) && !QUOTE_STARTS.test(nextLine)) ||
                    // Parenthetical content boundaries
                    (PARENTHETICAL_CONTENT.test(line) && !PARENTHETICAL_CONTENT.test(nextLine)) ||
                    // Dialog or speaker changes
                    (line.includes(':') && nextLine && !nextLine.startsWith(' ')) ||
                    // Natural transition words at start of next line
                    (nextLine && CONJUNCTION_STARTS.test(nextLine))
                );

                if (needsBreak) {
                    formattedLines.push(currentParagraph.join(' '));
                    currentParagraph = [];
                    
                    // Add an extra line break for major transitions
                    if (SENTENCE_ENDINGS.test(line) && 
                        nextLine && 
                        (CONJUNCTION_STARTS.test(nextLine) || nextLine.length > 100)) {
                        formattedLines.push('');
                    }
                }
            }

            // Add any remaining content
            if (currentParagraph.length) {
                formattedLines.push(currentParagraph.join(' '));
            }

            return formattedLines.join('\n');
        }

        function getLastWord(str) {
            return str.trim().split(/\s+/).pop().toLowerCase().replace(/[^a-z]/g, '');
        }

        function mightRhyme(word1, word2) {
            if (!word1 || !word2 || word1 === word2) return false;
            
            // Simple rhyme detection - check if words end with the same sounds
            const getEnding = word => {
                const vowels = 'aeiou';
                let idx = word.length - 1;
                while (idx >= 0 && !vowels.includes(word[idx])) idx--;
                return word.slice(idx);
            };
            
            return getEnding(word1) === getEnding(word2);
        }

        function validateContent(text) {
            const wordCount = text.trim().split(/\s+/).length;
            const MAX_WORDS = 10000;
            
            if (wordCount > MAX_WORDS) {
                throw new Error(`Content exceeds ${MAX_WORDS} words limit. Please shorten your text.`);
            }
            
            return text;
        }
        function setupInfiniteScroll() {
            const options = {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !isLoading && hasMore) {
                        currentPage++;
                        displayContent(true);
                    }
                });
            }, options);
            const sentinel = document.createElement('div');
            sentinel.id = 'sentinel';
            sentinel.style.height = '1px';
            document.getElementById('contentList').after(sentinel);
            observer.observe(sentinel);
        }
        function addLoader() {
            const loaderHtml = `
                <div id="loader" class="hidden col-span-full flex justify-center p-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#4DDFC6]"></div>
                </div>
            `;
            document.getElementById('contentList').insertAdjacentHTML('afterend', loaderHtml);
        }
        function animateCards() {
            const cards = document.querySelectorAll('.content-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.remove('opacity-0');
                }, index * 100);
            });
        }
        const originalDisplayContent = displayContent;
        displayContent = async function(append = false) {
            await originalDisplayContent(append);
            animateCards();
        };
        

        async function shareContent(event) {
            event.stopPropagation();
            
            if (!currentContent || !currentContent._id) {
                showNotification('Unable to share this content', 'error');
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?thought=${currentContent._id}`;

            const contentType = (currentContent.type || 'thought').charAt(0).toUpperCase() + 
                            (currentContent.type || 'thought').slice(1);
            
            const title = currentContent.title || `Untitled ${contentType}`;
            let text = currentContent.text || '';
            const author = currentContent.author || 'Anonymous';
            
            const maxLength = 150;
            let truncatedText = text.length > maxLength 
                ? text.substr(0, text.lastIndexOf(' ', maxLength)) + '...'
                : text;

            const typeEmoji = {
                'Story': 'üìñ',
                'Thought': 'üí≠',
                'Poem': 'üìù',
                'default': '‚ú®'
            };

            try {
                if (navigator.share) {
                    // Mobile format - more detailed with formatting
                    const emoji = typeEmoji[contentType] || typeEmoji.default;
                    const shareText = `${emoji} ${contentType}: "${title}" by ${author}\n"${truncatedText}"\nRead more üëá`;
                    
                    await navigator.share({
                        title: `${title} - by ${author}`,
                        text: shareText,
                        url: shareUrl
                    });
                    showNotification('Shared successfully!', 'success');
                } else {
                    // Desktop format - just copy the URL
                    copyToClipboard(shareUrl);
                }
            } catch (error) {
                console.error('Sharing failed:', error);
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
                    .then(() => showNotification('Link copied to clipboard!', 'success'))
                    .catch(() => fallbackCopyToClipboard(text));
                return;
            }
            
            fallbackCopyToClipboard(text);
        }

        function fallbackCopyToClipboard(text) {
            const input = document.createElement('input');
            input.style.position = 'fixed';
            input.style.opacity = 0;
            input.value = text;
            document.body.appendChild(input);
            input.select();
            input.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showNotification('Link copied to clipboard!', 'success');
            } catch (err) {
                showNotification('Failed to copy link', 'error');
            }
            document.body.removeChild(input);
        }
    </script>
    
</body>
</html>
